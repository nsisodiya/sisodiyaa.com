<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>DoonB2B Product Info</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      #scanner-container {
        width: 100%;
        position: relative;
      }
      #scanner-container video {
        width: 100%;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      #scanner-container .drawingBuffer,
      #scanner-container canvas {
        display: none;
      }
      .price-info {
        font-size: 35px;
        font-weight: bold;
        color: #236591;
      }
      #product-info {
        box-sizing: border-box;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: none;
        text-align: center;
        width: 100%;
      }
      #product-info #product-name {
        font-size: 40px;
        color: #236591;
        font-weight: bold;
      }
      #product-info #sku {
        font-size: 30px;
        color: #236591;
        font-weight: bold;
      }
      .carousel {
        overflow-x: auto;
        display: flex;
        scroll-snap-type: x mandatory;
        gap: 10px;
        margin: 20px 0;
      }
      .carousel img {
        scroll-snap-align: center;
        flex-shrink: 0;
        width: 100%;
        max-width: 86%;
        border-radius: 8px;
        object-fit: contain;
      }
      button {
        width: 100%;
        padding: 15px;
        font-size: 30px;
        border: none;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
      }
      .scan-again {
        background: #236591;
        color: #fff;
      }
      .share-whatsapp {
        background: #25d366;
        color: white;
      }
      .copy-link {
        background: #f0ad4e;
        color: white;
      }
      .loading {
        text-align: center;
        padding: 20px;
        font-size: 24px;
        color: #236591;
      }
    </style>
  </head>

  <body>
    <button class="scan-again" onclick="startScanner()">Scan Product</button>

    <div id="scanner-container"></div>

    <div id="product-info">
      <h2 id="product-name"></h2>
      <p><span id="sku"></span></p>
      <div class="price-info">
        <p>Sale Price: â‚¹<span id="sale-price"></span></p>
      </div>
      <div class="carousel" id="image-carousel"></div>
      <div class="insta-embed" id="insta-container"></div>
      <button class="share-whatsapp" onclick="shareOnWhatsApp()">
        Share on WhatsApp
      </button>
      <button class="copy-link" onclick="copyLink()">Copy Link</button>
    </div>

    <div id="loading" class="loading" style="display: none">
      Loading Product...
    </div>

    <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
    <script src="./public-product-info.js"></script>

    <script>
      let quaggaStarted = false;

      function startScanner() {
        clearItemCodeFromUrl();
        document.getElementById('scanner-container').style.display = 'block';
        document.getElementById('product-info').style.display = 'none';
        document.getElementById('loading').style.display = 'none';

        if (quaggaStarted) {
          Quagga.stop();
        }

        Quagga.init(
          {
            inputStream: {
              name: 'Live',
              type: 'LiveStream',
              target: document.querySelector('#scanner-container'),
              constraints: { facingMode: 'environment' }
            },
            decoder: {
              readers: ['ean_reader', 'code_128_reader', 'upc_reader']
            }
          },
          function (err) {
            if (err) {
              console.error(err);
              return;
            }
            Quagga.start();
            quaggaStarted = true;
          }
        );

        Quagga.onDetected((result) => {
          const code = result.codeResult.code;
          if (window.productInfo[code]) {
            Quagga.offDetected();
            showProduct(window.productInfo[code]);
            Quagga.stop();
            quaggaStarted = false;
          } else {
            console.warn('SKU not found:', code);
          }
        });
      }

      function showProduct(data) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('scanner-container').style.display = 'none';

        setTimeout(() => {
          // Add a slight delay to show "Loading..."
          const carousel = document.getElementById('image-carousel');
          carousel.innerHTML = '';
          data.images.forEach((imgUrl) => {
            const img = document.createElement('img');
            img.src = imgUrl;
            carousel.appendChild(img);
          });
          carousel.scrollLeft = 0;

          document.getElementById('product-name').innerText = data.title;
          document.getElementById('sku').innerText = data.sku;
          document.getElementById('sale-price').innerText = data.salePrice;

          const instaContainer = document.getElementById('insta-container');
          instaContainer.innerHTML = data.instalUrl
            ? `<blockquote class="instagram-media" data-instgrm-permalink="${data.instalUrl}" data-instgrm-version="14"></blockquote>`
            : '';

          if (data.instalUrl) {
            loadInstagramEmbed();
          }

          document.getElementById('product-info').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
        }, 400);
      }

      function loadInstagramEmbed() {
        if (!window.instgrm) {
          const script = document.createElement('script');
          script.src = 'https://www.instagram.com/embed.js';
          script.onload = () => window.instgrm.Embeds.process();
          document.body.appendChild(script);
        } else {
          window.instgrm.Embeds.process();
        }
      }

      function shareOnWhatsApp() {
        const itemCode = document.getElementById('sku').innerText.split('_')[0];
        const url = new URL(window.location);
        url.searchParams.set('itemCode', itemCode);
        const productUrl =
          url.origin + url.pathname + '?' + url.searchParams.toString();
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(
          'Check out this product: ' + productUrl
        )}`;
        window.open(whatsappUrl, '_blank');
      }

      function copyLink() {
        const itemCode = document.getElementById('sku').innerText.split('_')[0];
        const url = new URL(window.location);
        url.searchParams.set('itemCode', itemCode);
        const productUrl =
          url.origin + url.pathname + '?' + url.searchParams.toString();
        navigator.clipboard
          .writeText(productUrl)
          .then(() => alert('Link copied to clipboard!'))
          .catch((err) => console.error('Failed to copy: ', err));
      }

      function clearItemCodeFromUrl() {
        const url = new URL(window.location);
        url.searchParams.delete('itemCode');
        window.history.replaceState({}, document.title, url.pathname);
      }

      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const itemCode = urlParams.get('itemCode');
        if (itemCode && window.productInfo[itemCode]) {
          showProduct(window.productInfo[itemCode]);
        }
      };
    </script>
  </body>
</html>
