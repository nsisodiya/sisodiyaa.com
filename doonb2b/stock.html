<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DoonB2B Stock Report</title>
    <script src="./public-product-info.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 10mm;
      }

      h2.no-print {
        text-align: center;
        margin-bottom: 16px;
      }

      button.clear-btn {
        display: block;
        margin: 0 auto 20px;
        padding: 10px 16px;
        font-size: 16px;
        background-color: #236591;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }

      .all-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
      }

      .card {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
        border-radius: 8px;
        cursor: pointer;
        transition: border 0.3s ease;
      }

      .card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }

      .card .sku {
        margin-top: 8px;
        font-weight: 500;
        font-size: 12px;
        color: #333;
        padding-bottom: 10px;
        word-break: break-word;
      }

      .card .price,
      .card .qty,
      .card .missing {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.85);
        padding: 1px 6px;
        font-size: 16px;
        border-radius: 8px;
        font-weight: 600;
        color: #000;
        border: 1px solid #071361;
        user-select: none;
      }

      .card .price {
        top: 0px;
        left: 0px;
      }

      .card .qty {
        bottom: 80px;
        left: 0px;
      }

      .card .missing {
        bottom: 80px;
        right: 0px;
        color: #b00000;
        border-color: #b00000;
        font-weight: 700;
        background-color: rgba(255, 230, 230, 0.9);
      }

      .card.missing-stock {
        border: 3px solid #b00000;
      }

      @media print {
        body {
          margin: 0;
        }

        .card {
          page-break-inside: avoid;
        }

        .no-print {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <script>
      const STORAGE_KEY = 'dehradun-doonb2b-stock-check';

      function getThumbnailImage(url) {
        return url.replace(
          /(\.jpg|\.png|\.webp|\.jpeg)(\?.*)?$/,
          '_150x150$1$2'
        );
      }

      function saveToLocalStorage(stockMap) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stockMap));
      }

      function loadFromLocalStorage() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      }

      function clearLocalStorage() {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }

      function renderCards(data) {
        const heading = document.createElement('h2');
        heading.className = 'no-print';
        heading.textContent = 'DoonB2B Stock Report Sheet';
        document.body.appendChild(heading);

        const clearBtn = document.createElement('button');
        clearBtn.className = 'no-print clear-btn';
        clearBtn.textContent = 'Clear Local Storage';
        clearBtn.addEventListener('click', clearLocalStorage);
        document.body.appendChild(clearBtn);

        const container = document.createElement('div');
        container.id = 'cards-container';
        container.className = 'all-cards';
        document.body.appendChild(container);

        const stockMap = loadFromLocalStorage();

        Object.entries(data).forEach(([sku, product]) => {
          const totalQty = product.items_per_bag
            ? Math.round(product.closingQuantity * product.items_per_bag)
            : product.closingQuantity;

          const enteredQty = stockMap[sku] ? parseInt(stockMap[sku]) : null;
          // If quantity matched or exceeded, skip rendering card
          if (enteredQty !== null && enteredQty >= totalQty) {
            return;
          }

          const image = getThumbnailImage(product.images?.[0] || '');
          const price = Math.round(product.salePrice * 1.1);
          const qtyLabel = product.items_per_bag
            ? totalQty + ' items'
            : totalQty;

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <img src="${image}" alt="${sku}">
            <div class="sku">${sku}</div>
            <div class="price">â‚¹ ${price}</div>
            <div class="qty">${qtyLabel}</div>
          `;

          // If previously entered qty less than totalQty, show red border + missing label
          if (enteredQty !== null && enteredQty < totalQty) {
            card.classList.add('missing-stock');
            const missingCount = totalQty - enteredQty;
            const missingDiv = document.createElement('div');
            missingDiv.className = 'missing';
            missingDiv.textContent = `${missingCount} missing`;
            card.appendChild(missingDiv);
          }

          card.addEventListener('click', () => {
            let userInput = prompt(
              `Enter counted quantity for SKU: ${sku}\nExpected: ${totalQty}`,
              enteredQty !== null ? enteredQty : ''
            );
            if (userInput === null) return; // cancelled

            userInput = parseInt(userInput);
            if (isNaN(userInput) || userInput < 0) {
              alert('Please enter a valid non-negative number');
              return;
            }

            stockMap[sku] = userInput;
            saveToLocalStorage(stockMap);

            if (userInput >= totalQty) {
              card.remove();
            } else {
              card.classList.add('missing-stock');
              let missingDiv = card.querySelector('.missing');
              if (!missingDiv) {
                missingDiv = document.createElement('div');
                missingDiv.className = 'missing';
                card.appendChild(missingDiv);
              }
              missingDiv.textContent = `${totalQty - userInput} missing`;
            }
          });

          container.appendChild(card);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        const data = window.productInfo?.skuToProductInfo || {};
        renderCards(data);
      });
    </script>
  </body>
</html>
